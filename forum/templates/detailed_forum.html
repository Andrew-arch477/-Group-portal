<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-DQvkBjpPgn7RC31MCQoOeC9TI2kdqa4+BSgNMNj8v77fdC77Kj5zpWFTJaaAoMbC" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="{% static css_file %}?v=2">
    <link rel= "stylesheet" href= "https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css" >
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary" data-bs-theme="dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="{% url 'home' %}">Group Portal</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" aria-current="page" href="{% url 'home' %}">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="{% url 'forums' %}">Forum</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'calendar_event' %}">Calender</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'portfolio' %}">Portfolio</a>
              </li>
            </ul>
              <div class="d-flex">
              {% if user.is_authenticated %}
                  <form method="post" action="{% url 'logout' %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Вийти з аккаунту</button>
                </form>
              {% else %}
                  <a href="{% url 'login' %}" class="btn btn-outline-primary ms-2">Log in</a>
                  <a href="{% url 'register' %}" class="btn btn-outline-success ms-2">Register</a>
              {% endif %}
            </div>
          </div>
        </div>
    </nav>
    <a href="{% url 'forums' %}" class="btn_back">Назад</a>
    <h1>{{ forum.title }}</h1>
    
    <div class="horizontal">
        
        <div class="vertical_alignment_forum_list">
            
            {% if forums %}
            {% for forum in forums %}
            <div class="horizontal {% if forum.id == forum_id %}selected_forum{% endif %}">
                <a href="{% url 'detailed_forum' forum_id=forum.id %}">{{ forum.title }}</a>
                <p>{{ forum.created_date }}</p>
            </div>
                <hr>
                
            {% endfor %}
            {% endif %}
            {% if not forums %}
                <p>No forums yet</p>
            {% endif %}
        </div>
    <div class="vertical-line"></div>
    <div class="vertical_alignment_messages">
        {% if user.is_authenticated %}
            <form method="post" class="message_form">
                {% csrf_token %}
                {{ form.text }}
                <button type="submit" class="send"><i class="lar la-paper-plane"></i>
                </button>
            </form>
        {% endif %}
        {% if not user.is_authenticated %}
            <form method="post" class="message_form">
                {% csrf_token %}
                {{ form.text }}
            </form>
        {% endif %}
        {% if messages %}
            {% for message in messages %}
                {% if message.user != request.user%}
                
                <div class="horizontal">
                    <p class="p_not_me">{{ message.user }}</p>
                    
                    
                </div>
                <div class="message_block_not_me">
                    {% if message.reply %}
                        <div class="replied_not_me">
                            <p>Replied to {{ message.reply.user }}</p>
                        </div>
                    {% endif %}
                    <div class="message {% if message.reply %}has_reply{% else %}no_reply{% endif %}">
                        <div class="message_content">
                            {% if user.is_authenticated %}
                            <div class="btn_group">
                                
                                <button onclick="open_reply_form('{{ message.id }}')" class="reply"><i class="las la-reply"></i></button>
                                <div class="edit_delete">
                                    {% if role == 'admin' or role == 'moderator' %}
                                    <button onclick="open_delete_form('{{ message.id }}')" class="delete"><i class="lar la-trash-alt"></i></button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            <div class="message_box">
                                {{message.text}}
                            </div>
                        </div>
                        <span class="date">{{message.created_date}}</span>
                    </div> 
                </div>
                {% endif %}
                {% if message.user == request.user%}
                    
                <p class="p_me">{{ message.user }}</p>

                <div class="message_block">
                        {% if message.reply %}
                            <div class="replied_me">
                                <p>Replied to {{ message.reply.user }}</p>
                            </div>
                        {% endif %}
                
                    <div class="message_me {% if message.reply %}has_reply{% else %}no_reply{% endif %}">
                        
                        <div class="message_content">
                            {% if user.is_authenticated %}
                            <div class="btn_group">
                                
                                <button onclick="open_reply_form('{{ message.id }}')" class="reply"><i class="las la-reply"></i></button>
                                <div class="edit_delete">
                                    {% if role == 'admin' or role == 'moderator' or message.user == request.user%}
                                    
                                    <button onclick="open_delete_form('{{ message.id }}')" class="delete"><i class="lar la-trash-alt"></i></button>
                                    {% endif %}
                                    <button onclick="open_edit_form('{{ message.id }}')" class="edit"><i class="las la-edit"></i></button>
                                </div>
                            </div>
                            {% endif %}
                            <div class="message_box">
                                {{message.text}}

                                
                            </div>
                        
                        </div>
                        <span class="date">{{message.created_date}}</span>
                    </div> 
                </div>
                    
                {% endif %}

                <div id="delete_form_{{ message.id }}" style="display: none;">
                <div class="popup_content">
                    <form method="post">
                        {% csrf_token %}
                        <div class="popup-content"></div>
                        <input type="hidden" name="delete_id" value="{{ message.id }}">
                        <p>Are you sure you want to delete this message?</p>
                        <button type="submit" name="delete" class="buttons_group_buttons_delete">Delete</button>
                        <button type="button" onclick="close_delete_form('{{ message.id }}')" class="buttons_group_buttons_edit">Close</button>
                    </form>
                </div>
                </div>
            
                

                <div id="reply_form_{{ message.id }}" style="display: none;">
                    <form method="post" class="message_form">
                        {% csrf_token %}
                        <input type="hidden" name="reply_to_id" value="{{ message.id }}">
                        <div class="vertical">
                        <div class="replying_to">
                            Replying to <b>@{{ message.user }}</b>
                        </div>
                        <div class="form_body">
                        {{form.text}}
                        <button type="submit" class="send"><i class="lar la-paper-plane"></i></button>
                        </div>
                        </div>
                    </form>
                </div>
                <div id="edit_form_{{ message.id }}" style="display: none;">
                    <form method="post" class="message_form">
                        {% csrf_token %}
                        <input type="hidden" name="edit_id" value="{{ message.id }}">
                        <textarea name="text" class="form-control" rows="2" style="width: 90%;" required>{{ message.text }}</textarea>
                        <button type="submit" class="save">Save</button>
                    </form>
                </div>
                
                
                
            {% endfor %}
        {% endif %}
        {% if not messages %}
            
            <p>No messages yet</p>
        {% endif %}
        



    </div>
    
    </div>

    <script>
        function open_reply_form(messageId) {
            document.getElementById(
                `reply_form_${messageId}`
            ).style.display = "block";
        }
        function open_edit_form(messageId) {
            document.getElementById(
                `edit_form_${messageId}`
            ).style.display = "block";
        }
        function open_delete_form(messageId) {
          document.getElementById(
              `delete_form_${messageId}`
          ).style.display = "block";
        }
        function close_delete_form(messageId) {
            document.getElementById(
                `delete_form_${messageId}`
            ).style.display = "none";
        }
    </script>
    
</body>
</html>